<!DOCTYPE html >
<meta charset="utf-8">
<head>
	<title>WISEBED REST/WebSocket API v2.3 - Home</title>
	<link rel="stylesheet" media="screen" href="css/bootstrap.css">
	<link rel="stylesheet" media="screen" href="css/prettify.css">
	<link rel="stylesheet" media="screen" href="css/wisebed-gui.css">
	<script type="text/javascript" src="js/jquery-1.7.1.js"></script>
	<script type="text/javascript" src="js/jquery.ba-bbq.min.js"></script>
	<script type="text/javascript" src="js/jquery.cookie.js"></script>
	<script type="text/javascript" src="js/bootstrap-dropdown-1.4.0.js"></script>
	<script type="text/javascript" src="js/bootstrap-tabs-1.4.0.js"></script>
	<script type="text/javascript" src="js/prettify.js"></script>
	<script type="text/javascript" src="js/wisebed.js"></script>
	<script type="text/javascript">

		function onAjaxError(jqXHR, textStatus, errorThrown) {
			console.log(jqXHR);
			console.log(textStatus);
			console.log(errorThrown);
			alert("Error while loading data: " + errorThrown);
		}

		function loadTestbedDetailsContainer(navigationData, parentDiv) {

			parentDiv.append($('<h1>Testbed Details '+navigationData.testbed+'</h1>'));

			var tabs = $('<ul class="tabs">'
					+ '	<li class="active"><a href="#WisebedTestbedDetailsDescription-'+navigationData.testbed+'">Description</a></li>'
					+ '	<li><a href="#WisebedTestbedDetailsNodes-'+navigationData.testbed+'">Nodes</a></li>'
					+ '	<li><a href="#WisebedTestbedDetailsReservations-'+navigationData.testbed+'">Reservations</a></li>'
					+ '	<li><a href="#WisebedTestbedDetailsWiseMLJSON-'+navigationData.testbed+'">WiseML (JSON)</a></li>'
					+ '	<li><a href="#WisebedTestbedDetailsWiseMLXML-'+navigationData.testbed+'">WiseML (XML)</a></li>'
					+ '</ul>'
					+ '<div class="tab-content">'
					+ '	<div class="tab-pane active" id="WisebedTestbedDetailsDescription-'+navigationData.testbed+'"/>'
					+ '	<div class="tab-pane" id="WisebedTestbedDetailsNodes-'+navigationData.testbed+'"/>'
					+ '	<div class="tab-pane" id="WisebedTestbedDetailsReservations-'+navigationData.testbed+'"/>'
					+ '	<div class="tab-pane" id="WisebedTestbedDetailsWiseMLJSON-'+navigationData.testbed+'"/>'
					+ '	<div class="tab-pane" id="WisebedTestbedDetailsWiseMLXML-'+navigationData.testbed+'"/>'
					+ '</div>');

			parentDiv.append(tabs);

			Wisebed.getWiseMLAsJSON(
					navigationData.testbed,
					null,
					function(wiseML) {

						var jsonTab = $('#WisebedTestbedDetailsWiseMLJSON-'+navigationData.testbed);
						jsonTab.append($('<pre>'+JSON.stringify(wiseML, null, '  ')+'</pre>'));

						var descriptionTab = $('#WisebedTestbedDetailsDescription-'+navigationData.testbed);
						descriptionTab.append(wiseML.setup.description);
					},
					onAjaxError
			);
			
			Wisebed.getWiseMLAsXML(
					navigationData.testbed,
					null,
					function(wiseML) {
						var xmlTab = $('#WisebedTestbedDetailsWiseMLXML-'+navigationData.testbed);
						xmlTab.append($('<pre lang="xml">'+new XMLSerializer().serializeToString(wiseML).replace(/</g,"&lt;")+'</pre>'));
					},
					onAjaxError
			);

			var now = new Date();
			var tomorrowSameTime = new Date();
			tomorrowSameTime.setDate(now.getDate() + 1);

			Wisebed.getReservations(
					navigationData.testbed,
					now,
					tomorrowSameTime,
					function(data) {
						var reservations = data.reservations;
						var reservationsTab = $('#WisebedTestbedDetailsReservations-'+navigationData.testbed);
						var reservationsTable = $('<table class="zebra-striped">'
								+ '	<thead>'
								+ '		<tr>'
								+ '			<td>From</td>'
								+ '			<td>Until</td>'
								+ '			<td>User Data</td>'
								+ '			<td>Node URNs</td>'
								+ '		</tr>'
								+ '	</thead>'
								+ '	<tbody>'
								+ '	</tbody>'
								+ '</table>');
						reservationsTab.append(reservationsTable);
						var reservationsTableBody = reservationsTable.children('tbody');
						for (var i=0; i<reservations.length; i++) {
							var reservationRow = $('<tr>'
									+ '	<td>'+new Date(reservations[i].from).toString()+'</td>'
									+ '	<td>'+new Date(reservations[i].to).toString()+'</td>'
									+ '	<td>'+reservations[i].userData+'</td>'
									+ '	<td>'+reservations[i].nodeURNs.join("<br/>")+'</td>'
									+ '</tr>');
							reservationsTableBody.append(reservationRow);
						}
					},
					onAjaxError
			);
		}

		function loadExperimentContainer(navigationData, parentDiv) {
			parentDiv.append($('<h1>Experiment '+navigationData.testbed+' '+navigationData.experiment+'</h1>'));
		}

		function loadTestbedOverviewContainer(navigationData, parentDiv) {

			function fillTestbedOverviewTable(parentDiv) {
				Wisebed.getTestbeds(
						function(data){
							console.log(data);
							$.each(data.testbedMap, function(key, value) {
								var tr = $('<tr/>');
								var tdName = $('<td><a href="#nav=testbed&testbed='+key+'">'+value.name+'</a></td>');
								var tdUrnPrefixes = $('<td>'+value.urnPrefixes+'</td>');
								var tdSessionManagementEndpointUrl = $('<td>'+value.sessionManagementEndpointUrl+'</td>');
								tr.append(tdName, tdUrnPrefixes, tdSessionManagementEndpointUrl);
								parentDiv.children('.WisebedOverviewTable').append(tr);
							});

						},
						function(jqXHR, textStatus, errorThrown) {
							alert("Error while fetching testbed list: " + jqXHR.responseText);
						}
				);
			}

			$.ajax({
				url: "parts/testbed-overview.html",
				success: function(html) {
					parentDiv.html(html);
					fillTestbedOverviewTable(parentDiv);
				},
				error: function(jqXHR, textStatus, errorThrown) {
					$('#WisebedContainer').html('<h1>Unable to load list of testbeds!</h1><h2>'+errorThrown+'</h2>');
				},
				context: document.body,
				dataType: "html"
			});
		}

		var appState = {
		};

		function getAppStateKey(nav, testbed, experiment) {
			if (nav == 'overview') {return 'overview'}
			if (nav == 'testbed' && experiment == '') {return 'testbed=' + testbed}
			if (nav == 'testbed' && experiment != '') {return 'testbed=' + testbed + '&experiment=' + experiment}
			return undefined;
		}

		function getCreateContentFunction(nav, testbed, experiment) {
			if (nav == 'overview') {return loadTestbedOverviewContainer}
			if (nav == 'testbed' && experiment == '') {return loadTestbedDetailsContainer}
			if (nav == 'testbed' && experiment != '') {return loadExperimentContainer}
			return undefined;
		}

		function loadNavigationBar(callbackDone) {
			$.ajax({
				url: "parts/navigation.html",
				success: function(html) {
					$('#WisebedContainer').append(html);
					callbackDone();
				},
				error: function(jqXHR, textStatus, errorThrown) {
					$('#WisebedContainer').append('<h1>Application could not be loaded!</h1><br/><h2>Reason</h2>' + errorThrown + '<br/>' +jqXHR.responseText);
				},
				context: document.body,
				dataType: "html"
			});
		}

		function showReservationsDialog() {
			alert('TODO');
		}

		function showLoginDialog() {
			alert('TODO');
		}

		function adaptNavigationBar(navigationData) {

			var ul = $('#WisebedContainer div.WisebedNavigation ul.WisebedNavigationUl');
			var experimentsContainer = $('#WisebedNavigationExperimentsForm');
			var secondaryUl = $('#WisebedContainer div.WisebedNavigation ul.WisebedNavigationSecondaryUl');

			if (navigationData.nav == 'overview') {

				ul.empty();
				secondaryUl.empty();
				experimentsContainer.empty();

				ul.append('<li class="active"><a href="#nav=overview">Testbed Overview</a></li>');

			} else if (navigationData.nav == 'testbed') {

				ul.empty();
				secondaryUl.empty();
				experimentsContainer.empty();

				ul.append('<li><a href="#nav=overview">Testbed Overview</a></li>');
				experimentsContainer.append('Running Experiments <select id="WisebedNavigationExperimentSelect" disabled="true"></select>');

				secondaryUl.append('<li><a href="javascript:showReservationsDialog()">Reservations</a></li>');

				if (Wisebed.hasSecretAuthenticationKeyCookie(navigationData.testbed)) {
					var select = $('#WisebedNavigationExperimentSelect');
					select[0].disabled = false;
					fillWisebedNavigationExperimentSelect(select, navigationData);

					secondaryUl.append('<li><a href="javascript:logout(\''+navigationData.testbed+'\')">Logout</a></li>');
				} else {
					secondaryUl.append('<li><a href="javascript:showLoginDialog(\''+navigationData.testbed+'\')">Login</a></li>');
				}
			}
		}

		function logout(testbedId) {
			Wisebed.deleteSecretAuthenticationKeyCookie(testbedId);
			document.location='#';
		}

		function fillWisebedNavigationExperimentSelect(select, navigationData) {
			console.log('TODO fillWisebedNavigationExperimentSelect');
		}

		function onHashChange(e) {

			var nav = $.bbq.getState('nav') || 'overview';
			var testbed = $.bbq.getState('testbed') || '';
			var experiment = $.bbq.getState('experiment') || '';

			var appStateKey = getAppStateKey(nav, testbed, experiment);
			var createContentFunction = getCreateContentFunction(nav, testbed, experiment);
			var navigationData = {nav:nav, testbed:testbed, experiment:experiment};

			adaptNavigationBar(navigationData);

			console.log(navigationData);

			$('#WisebedContainer .WisebedContentContainer').children(':visible').hide();

			console.log("appStateKey=" + appStateKey);
			console.log("appState["+appStateKey+"]=" + appState[appStateKey]);

			if (appState[appStateKey]) {

				console.log("Loading container for: " + JSON.stringify(navigationData));
				$(appState[appStateKey]).show();

			} else {

				console.log("Creating container for: " + JSON.stringify(navigationData));

				var parentDiv = $('<div/>');
				$('#WisebedContainer .WisebedContentContainer').append(parentDiv);
				createContentFunction(navigationData, parentDiv);
				appState[appStateKey] = parentDiv;
				console.log(appState);

				$('.tabs').tabs();
			}
		}

		$(function () {

			$(window).bind('hashchange', onHashChange);

			loadNavigationBar(function() {
				$('#WisebedContainer').append('<div class="WisebedContentContainer"/>');
				$(window).trigger('hashchange');
			});

			console.log("cookie:");
			console.log(document.cookie);
		});

	</script>
</head>
<body>

<div class="container">
	Real-World G-Lab / WISEBED / Spitfire Testbed GUI
</div>

<div id="WisebedContainer" class="container">

</div>

</body>
</html>