<!DOCTYPE html >
<meta charset="utf-8">
<head>

	<title>WISEBED REST/WebSocket API v2.3 - Home</title>

	<link rel="stylesheet" media="screen" href="css/bootstrap.css">
	<link rel="stylesheet" media="screen" href="css/prettify.css">
	<link rel="stylesheet" media="screen" href="css/wisegui.css">

	<script type="text/javascript" src="js/jquery-1.7.1.js"></script>
	<script type="text/javascript" src="js/jquery.ba-bbq.min.js"></script>
	<script type="text/javascript" src="js/jquery.cookie.js"></script>
	<script type="text/javascript" src="js/jquery.tablesorter.min.js"></script>
	<script type="text/javascript" src="js/jquery.dateformat-1.0.js"></script>

	<script type="text/javascript" src="js/bootstrap-dropdown-1.4.0.js"></script>
	<script type="text/javascript" src="js/bootstrap-tabs-1.4.0.js"></script>
	<script type="text/javascript" src="js/bootstrap-modal-1.4.0.js"></script>
	<script type="text/javascript" src="js/bootstrap-alerts-1.4.0.js"></script>

	<script type="text/javascript" src="js/prettify.js"></script>
	<script type="text/javascript" src="js/phpjs/explode.js"></script>
	<script type="text/javascript" src="js/phpjs/implode.js"></script>
	<script type="text/javascript" src="js/wisebed.js"></script>
	<script type="text/javascript" src="js/wisegui.js"></script>

	<script type="text/javascript">

		function onAjaxError(jqXHR, textStatus, errorThrown) {
			console.log(jqXHR);
			console.log(textStatus);
			console.log(errorThrown);
			alert("Error while loading data: " + errorThrown);
		}

		function loadTestbedDetailsContainer(navigationData, parentDiv) {

			parentDiv.append($('<h1>Testbed Details '+navigationData.testbedId+'</h1>'));

			var tabs = $('<ul class="tabs">'
					+ '	<li class="active"><a href="#WisebedTestbedDetailsDescription-'+navigationData.testbedId+'">Description</a></li>'
					+ '	<li><a href="#WisebedTestbedDetailsNodes-'+navigationData.testbedId+'">Nodes</a></li>'
					+ '	<li><a href="#WisebedTestbedDetailsReservations-'+navigationData.testbedId+'">Reservations</a></li>'
					+ '	<li><a href="#WisebedTestbedDetailsWiseMLJSON-'+navigationData.testbedId+'">WiseML (JSON)</a></li>'
					+ '	<li><a href="#WisebedTestbedDetailsWiseMLXML-'+navigationData.testbedId+'">WiseML (XML)</a></li>'
					+ '</ul>'
					+ '<div class="tab-content">'
					+ '	<div class="tab-pane active" id="WisebedTestbedDetailsDescription-'+navigationData.testbedId+'"/>'
					+ '	<div class="tab-pane" id="WisebedTestbedDetailsNodes-'+navigationData.testbedId+'"/>'
					+ '	<div class="tab-pane" id="WisebedTestbedDetailsReservations-'+navigationData.testbedId+'"/>'
					+ '	<div class="tab-pane" id="WisebedTestbedDetailsWiseMLJSON-'+navigationData.testbedId+'"/>'
					+ '	<div class="tab-pane" id="WisebedTestbedDetailsWiseMLXML-'+navigationData.testbedId+'"/>'
					+ '</div>');

			parentDiv.append(tabs);

			Wisebed.getWiseMLAsJSON(
					navigationData.testbedId,
					null,
					function(wiseML) {

						var jsonTab = $('#WisebedTestbedDetailsWiseMLJSON-'+navigationData.testbedId);
						jsonTab.append($('<pre>'+JSON.stringify(wiseML, null, '  ')+'</pre>'));

						var descriptionTab = $('#WisebedTestbedDetailsDescription-'+navigationData.testbedId);
						descriptionTab.append(wiseML.setup.description);

						var nodesTab = $('#WisebedTestbedDetailsNodes-'+navigationData.testbedId);
						new WiseGuiNodeTable(wiseML, nodesTab, false, true);
					},
					onAjaxError
			);

			Wisebed.getWiseMLAsXML(
					navigationData.testbedId,
					null,
					function(wiseML) {
						var xmlTab = $('#WisebedTestbedDetailsWiseMLXML-'+navigationData.testbedId);
						xmlTab.append($('<pre lang="xml">'+new XMLSerializer().serializeToString(wiseML).replace(/</g,"&lt;")+'</pre>'));
					},
					onAjaxError
			);

			var now = new Date();
			var tomorrowSameTime = new Date();
			tomorrowSameTime.setDate(now.getDate() + 1);

			Wisebed.reservations.getPublic(
					navigationData.testbedId,
					now,
					tomorrowSameTime,
					function(data) {

						var reservations = data.reservations;
						var reservationsTab = $('#WisebedTestbedDetailsReservations-'+navigationData.testbedId);

						var tableHead = ["From", "Until", "User Data", "Node URNs"];
						var tableRows = [];
						for (var i=0; i<reservations.length; i++) {
							tableRows[i] = [];
							tableRows[i][0] = new Date(reservations[i].from).toString();
							tableRows[i][1] = new Date(reservations[i].to).toString();
							tableRows[i][2] = reservations[i].userData;
							tableRows[i][3] = reservations[i].nodeURNs.join("<br/>");
						}

						var table = buildTable(tableHead, tableRows);
						reservationsTab.append(table);
						if (tableRows.length > 0) {
							table.tablesorter({ sortList: [[0,0]] });
						}
					},
					onAjaxError
			);
		}

		function buildTable(tableHead, tableRows) {

			var table = $('<table class="zebra-striped"/>"');
			var thead = $('<thead/>');
			var theadRow = $('<tr/>');
			thead.append(theadRow);

			for (var i=0; i<tableHead.length; i++) {
				theadRow.append('<th>'+tableHead[i]+'</th>');
			}

			var tbody = $('<tbody/>');
			for (var k=0; k<tableRows.length; k++) {
				var row = $('<tr/>');
				tbody.append(row);
				for (var l=0; l<tableRows[k].length; l++) {
					row.append('<td>'+tableRows[k][l]+'</td>');
				}
			}

			table.append(thead, tbody);

			return table;
		}

		function loadExperimentContainer(navigationData, parentDiv) {

			var experimentationView = new WiseGuiExperimentationView(navigationData.testbedId, navigationData.experimentId);
			parentDiv.append(experimentationView.view);
		}

		function loadTestbedOverviewContainer(navigationData, parentDiv) {

			function fillTestbedOverviewTable(parentDiv) {
				Wisebed.getTestbeds(
						function(data){
							console.log(data);
							$.each(data.testbedMap, function(key, value) {
								var tr = $('<tr/>');
								var tdName = $('<td><a href="#nav=testbed&testbedId='+key+'">'+value.name+'</a></td>');
								var tdUrnPrefixes = $('<td>'+value.urnPrefixes+'</td>');
								var tdSessionManagementEndpointUrl = $('<td>'+value.sessionManagementEndpointUrl+'</td>');
								tr.append(tdName, tdUrnPrefixes, tdSessionManagementEndpointUrl);
								parentDiv.children('.WisebedOverviewTable').append(tr);
							});

						},
						function(jqXHR, textStatus, errorThrown) {
							alert("Error while fetching testbed list: " + jqXHR.responseText);
						}
				);
			}

			$.ajax({
				url: "parts/testbed-overview.html",
				success: function(html) {
					parentDiv.append(html);
					fillTestbedOverviewTable(parentDiv);
				},
				error: function(jqXHR, textStatus, errorThrown) {
					$('#WisebedContainer').html('<h1>Unable to load list of testbeds!</h1><h2>'+errorThrown+'</h2>');
				},
				context: document.body,
				dataType: "html"
			});
		}

		var appState = {};
		var reservationObservers = {};

		function getAppStateKey(navigationData) {
			if (navigationData.nav == 'overview') {
				return 'overview';
			} else if (navigationData.nav == 'testbed' && navigationData.experimentId == '') {
				return 'testbedId=' + navigationData.testbedId;
			} else if (navigationData.nav == 'testbed' && navigationData.experimentId != '') {
				return 'testbedId=' + navigationData.testbedId + '&experimentId=' + navigationData.experimentId;
			}
			return undefined;
		}

		function getCreateContentFunction(navigationData) {
			if (navigationData.nav == 'overview') {return loadTestbedOverviewContainer;}
			if (navigationData.nav == 'testbed' && navigationData.experimentId == '') {return loadTestbedDetailsContainer;}
			if (navigationData.nav == 'testbed' && navigationData.experimentId != '') {return loadExperimentContainer;}
			return undefined;
		}

		function loadNavigationBar(callbackDone) {
			$.ajax({
				url: "parts/navigation.html",
				success: function(html) {
					$('#WisebedContainer').append(html);
					callbackDone();
				},
				error: function(jqXHR, textStatus, errorThrown) {
					$('#WisebedContainer').append('<h1>Application could not be loaded!</h1><br/><h2>Reason</h2>' + errorThrown + '<br/>' +jqXHR.responseText);
				},
				context: document.body,
				dataType: "html"
			});
		}

		function showReservationsDialog() {
			alert('TODO');
		}

		function adaptNavigationBar(navigationData) {

			var ul = $('#WisebedContainer div.WisebedNavigation ul.WisebedNavigationUl');
			var experimentsContainer = $('#WisebedNavigationExperimentsForm');
			var secondaryUl = $('#WisebedContainer div.WisebedNavigation ul.WisebedNavigationSecondaryUl');

			if (navigationData.nav == 'overview') {

				ul.empty();
				secondaryUl.empty();
				experimentsContainer.empty();

				ul.append('<li class="active"><a href="#nav=overview">Testbed Overview</a></li>');

			} else if (navigationData.nav == 'testbed') {

				ul.empty();
				secondaryUl.empty();
				experimentsContainer.empty();

				ul.append('<li><a href="#nav=overview">Testbed Overview</a></li>');
				experimentsContainer.append('Running Experiments'
						+ '<select style="width:500px" id="WisebedNavigationExperimentSelect-'+navigationData.testbedId+'" disabled="true"></select>');

				if (Wisebed.hasSecretAuthenticationKeyCookie(navigationData.testbedId)) {

					if (!reservationObservers[navigationData.testbedId] || !reservationObservers[navigationData.testbedId].isObserving) {

						var reservationObserver = new WiseGuiReservationObserver(navigationData.testbedId);
						reservationObservers[navigationData.testbedId] = reservationObserver;
						reservationObserver.startObserving();
						console.log('Started observing reservations for testbed "'+navigationData.testbedId+'"');
					}

					var experimentDropDown = new WiseGuiExperimentDropDown(navigationData.testbedId);

					Wisebed.reservations.getPersonal(
							navigationData.testbedId,
							null,
							null,
							function(reservations) {
								var experimentSelect = $('#WisebedNavigationExperimentSelect-'+navigationData.testbedId);
								var option = $('<option/>');
								experimentSelect.append(option);
								$.each(reservations.reservations, function(index, reservation) {
									var from = new Date(reservation.from);
									var to = new Date(reservation.to);
									var option = $('<option>' + $.format.date(from, "yyyy-MM-dd HH:mm") + ' - ' + $.format.date(to, "yyyy-MM-dd HH:mm") + ' | ' + reservation.userData + '</option>');
									option.data('reservation', this);
									experimentSelect.append(option);
									console.log(option);
								});
								experimentSelect.attr('disabled', false);
								experimentSelect.bind('change', function(e) {
									var reservation = experimentSelect.find('option:selected').first().data('reservation');
									if (reservation) {
										navigateToExperiment(navigationData.testbedId, reservation);
									}
								});
							},
							onAjaxError
					);
				}

				secondaryUl.append('<li><a href="javascript:showReservationsDialog()">Reservations</a></li>');

				if (Wisebed.hasSecretAuthenticationKeyCookie(navigationData.testbedId)) {

					var select = $('#WisebedNavigationExperimentSelect-'+navigationData.testbedId);
					select[0].disabled = false;

					secondaryUl.append('<li><a href="javascript:;" id="WisebedLogoutButton-'+navigationData.testbedId+'">Logout</a></li>');
					$('#WisebedLogoutButton-'+navigationData.testbedId+':first').bind(
							'click',
							{testbedId:navigationData.testbedId},
							function(e){
								Wisebed.deleteSecretAuthenticationKeyCookie(e.data.testbedId);
								$(window).trigger('hashchange');
							}
					)

				} else {
					secondaryUl.append('<li><a href="javascript:;" id="WisebedLoginButton-'+navigationData.testbedId+'">Login</a></li>');
					$('#WisebedLoginButton-'+navigationData.testbedId+':first').bind(
							'click',
							{testbedId:navigationData.testbedId},
							function(e){
								WiseGuiLoginDialog.show(e.data.testbedId);
							}
					);
				}
			}
		}

		function buildWisebedNavigationReservationSelectBox(parentDiv, testbedId) {

		}

		function fillWisebedNavigationExperimentSelect(select, navigationData) {
			console.log('TODO fillWisebedNavigationExperimentSelect');
		}

		function navigateToExperiment(testbedId, reservation) {

			Wisebed.experiments.getUrl(
					testbedId,
					reservation,
					function(experimentUrl){

						var experimentId = experimentUrl.substr(experimentUrl.lastIndexOf('/') + 1);
						var navigationData = getNavigationData();
						navigationData.experimentId = experimentId;
						$.bbq.pushState(navigationData);

					},
					onAjaxError
			);
		}

		function getNavigationData() {

			return {
				nav          : $.bbq.getState('nav')          || 'overview',
				testbedId    : $.bbq.getState('testbedId')    || '',
				experimentId : $.bbq.getState('experimentId') || ''
			};
		}

		function onHashChange(e) {

			var navigationData = getNavigationData();

			var appStateKey = getAppStateKey(navigationData);
			var createContentFunction = getCreateContentFunction(navigationData);

			adaptNavigationBar(navigationData);

			$('#WisebedContainer .WisebedContentContainer').children(':visible').hide();

			console.log("appStateKey=" + appStateKey);
			console.log("appState["+appStateKey+"]=" + appState[appStateKey]);

			if (appState[appStateKey]) {

				console.log("Loading container for: " + JSON.stringify(navigationData));
				$(appState[appStateKey]).show();

			} else {

				console.log("Creating container for: " + JSON.stringify(navigationData));

				var container = $('<div id="WisebedContentContainer'+(navigationData.testbedId ? '-' + navigationData.testbedId : '')+'"/>');
				$('#WisebedContainer .WisebedContentContainer').append(container);
				createContentFunction(navigationData, container);

				appState[appStateKey] = container;

				if (navigationData.testbedId) {
					WiseGuiLoginDialog.createLoginDialogIfNotExisting(navigationData.testbedId, onAjaxError);
				}

				$('.tabs').tabs();
			}
		}

		var notificationsViewer;

		$(function () {

			$(window).bind('hashchange', onHashChange);

			loadNavigationBar(function() {
				notificationsViewer = new WiseGuiNotificationsViewer();
				$('#WisebedContainer').append(notificationsViewer.view);
				$('#WisebedContainer').append('<div class="WisebedContentContainer"/>');
				$(window).trigger('hashchange');
			});
		});
	</script>
</head>
<body>

<div class="container">
	Real-World G-Lab / WISEBED / Spitfire Testbed GUI
</div>

<div id="WisebedContainer" class="container">

</div>

</body>
</html>